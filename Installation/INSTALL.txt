################################################################################
#################### Installation of the DADA2 nifH pipeline ###################
################################################################################

The DADA2 nifH pipeline uses a bunch of external tools (R, DADA2, cutadapt,
...).  Obtaining them is simplified by first installing miniconda3, a software
package and environment manager. This document outlines how to get miniconda3
and then use it to create an "environment" for running the DADA2 pipeline.

These instructions are for installing tools on thalassa (linux machine).  The
overall process should be very similar if you want to set up to run on your
laptop.  Feel free to ask Jonathan for help.

Overview:
  0. Get the pipeline and all documentation (in a tgz file).
  1. Install Miniconda3, a package / environment manager.
  2. Create the DADA2_nifH environment. This step downloads most of the external
     tools and creates an environment in which they will be available when you
     run the pipeline.
  3. Install the DADA2 R package.
  4. Add the pipeline scripts to your path
  -- Installation completed! --
  5. Try the example

Below '%' is the unix shell prompt. Your's might differ.


--------------------------------------------------------------------------------
# 0. Get the DADA2 nifH pipeline, documents, etc.
--------------------------------------------------------------------------------

The file you are now reading is included in the DADA2 nifH package so you
probably already did this step.  If not, then do the following (for whichever
DATESTAMP you like, probably the most recent):

  % cd $HOME
  % tar xvfz /home/jmagasin/ToolsShared/NifH_amplicons/DADA2/Shared/DADA2_nifH_pipeline.DATESTAMP.tgz

This creates a local copy of the tools in your home directory under
DADA2_nifH_pipeline.


--------------------------------------------------------------------------------
# 1. Install Miniconda3
--------------------------------------------------------------------------------

In your home directory, create working directory for installing miniconda3.

  % cd $HOME
  % mkdir Miniconda3Install
  % cd Miniconda3Install

The instructions below are all executed within Miniconda3Install.


For background, check out the Miniconda3 installation guide (but below are the
few steps you need for installing):
    https://conda.io/projects/conda/en/latest/user-guide/install/index.html
For thalassa we want to do a linux installation:
    https://docs.conda.io/projects/conda/en/latest/user-guide/install/linux.html
The following will download the latest Miniconda3 installer for 64-bit linux and
calculate its SHA256 hash:

  % wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
  % sha256sum Miniconda3-latest-Linux-x86_64.sh

You should check that installer has not been corrupted or compromised by verifying
that the hash above matches the one you see at:
    https://docs.conda.io/en/latest/miniconda.html#latest-miniconda-installer-links
(If it does not, let me know!!)  In the table at the link you will see that the
latest Conda version is something >= 4.10.3.

Now to install Miniconda3:

  % bash Miniconda3-latest-Linux-x86_64.sh -b -p $HOME/miniconda3

The install script will guide you. When it asks for permission to do various
things, in general just accept whatever it suggests:) Do say "yes" when it asks
"Do you wish the installer to initialize Miniconda3 by running conda init?"
This makes it possible to run miniconda3 commands from the shell by simply
typing "conda" rather than the full path to conda ($HOME/miniconda3/bin/conda).
[Detail: "yes" gives permission to the installer to change your shell startup
script (.bashrc or .tchsrc) to add miniconda3 to your path.]

If the installer reports success, then the following two commands should
succeed.

  % which conda
  % conda --help

You can now delete Miniconda3-latest-Linux-x86_64.sh.


--------------------------------------------------------------------------------
# 2. Create the DADA2_nifH environment
--------------------------------------------------------------------------------

Create a conda environment called "DADA2_nifH" that includes everything needed
to run the DADA2 nifH pipeline. This step will take awhile (~10 min):

  % conda env update -n DADA2_nifH --file $HOME/DADA2_nifH_pipeline/Installation/environment_DADA2_nifH.yml

Installation 99% complete!  Let's verify the conda DADA2_nifH environment.
First, activate it:

  % conda activate DADA2_nifH

If this succeeds then your prompt will now be prefixed by the active conda
environment:

  (DADA2_nifH) %

Demonstrate that a few of the tools required by the DADA2 nifH pipeline are now
installed. (Example output shown for user "yourLoginHere".)

  (DADA2_nifH) % which R
  /home/yourLoginHere/miniconda3/envs/DADA2_nifH/bin/R
  (DADA2_nifH) % which cutadapt
  /home/yourLoginHere/miniconda3/envs/DADA2_nifH/bin/cutadapt
  (DADA2_nifH) % which hmmalign
  /home/yourLoginHere/miniconda3/envs/DADA2_nifH/bin/hmmalign

Later, you can deactivate the environment with:

  (DADA2_nifH) % conda deactivate

after which the commands just above will either give errors or versions of the
tools that are not managed by miniconda3 (e.g. the systemwide /usr/bin/R, which
is old and will not work with DADA2).

You can now delete the Miniconda3Install directory


--------------------------------------------------------------------------------
# 3. Install the DADA2 R package
--------------------------------------------------------------------------------

We will use Bioconductor (an R package) to install DADA2 just as described at:
    https://bioconductor.org/packages/release/bioc/html/dada2.html
This is the standard way to install ~any package using Bioconductor.  Start
R and in the R console paste the following lines:

   ## Install Bioconductor if necessary.
   if (!requireNamespace("BiocManager", quietly = TRUE))
       install.packages("BiocManager")
   ## Now use Bioconductor to install the latest dada2.  This takes a long time.
   ## Check in periodically because at some point you will be asked if you want
   ## to update all/some/none of several mysteriously named packages.  Choose
   ## all.
   BiocManager::install("dada2")

The install takes around 30 min on thalassa because DADA2 uses many additional
packages that must be downloaded and compiled.  At the end of a successful
install, you should see a few successful test messages.  Additionally you can
try loading dada2 yourself before exiting R:

    library(dada2) # Better work!
    quit()         # Hit 'n' when it asks if you want to save.


Notes:
  1. Step #2 above installed R v4.1 (specified in the .yml file) because that
     version is required for DADA2 v3.13, which was the most recent DADA2 on
     Aug. 12, 2021.  At some point, a new version of DADA2 might require a newer
     version of R and I will have to change the .yml file.  If step #3 fails,
     then perhaps we are at that poin!

  2. The DADA2 package was installed with the R that is within the DADA2_nifH
     environment.  You can only use it when DADA2_nifH is active.

  3. There is a way to install DADA2 using conda, however it seems broken as
     of Aug. 12, 2021.


--------------------------------------------------------------------------------
# 4. Add the pipeline scripts to your path
--------------------------------------------------------------------------------

The tools that you installed with conda will automatically be in your path when
DADA2_nifH is active. However, my scripts are not a conda package and have to be
added to your path in this separate step.  We will update the path using conda
so that it is only in effect when DADA2_nifH is active.  

The steps below assume you installed the pipeline in your home directory as
described in step #0.  I.e. everything must be in "~/DADA2_nifH_pipeline".  If
you installed elsewhere, just adjust added path components accordingly.

First, determine if your shell is bash or tcsh because the syntax differs
slightly depending on which:

  (DADA2_nifH) % echo $0

If bash, then do this, being careful that double and single quotes are exactly
as shown (so use caution if you are e.g. pasting from a Word doc or email!):

  (DADA2_nifH) % conda env config vars set PATH="$PATH"':~/DADA2_nifH_pipeline:~/DADA2_nifH_pipeline/scripts'

If tcsh, do this (lower case path, spaces are critical):
FIXME FIXME FIXME: The tcsch version might not work after all. (bash version is fine)

  (DADA2_nifH) % conda env config vars set path="$path"' ~/DADA2_nifH_pipeline ~/DADA2_nifH_pipeline/scripts'

Now reactivate the environment so the change takes effect, and then verify that
the shell can now find the main pipeline script and organizeFastqs.R:

  (DADA2_nifH) % conda activate DADA2_nifH
  (DADA2_nifH) % which run_DADA2_pipeline.sh
  (DADA2_nifH) % which organizeFastqs.R

That's it!  You should now be able to run the pipeline on a small example.


--------------------------------------------------------------------------------
# 5. Try the mini Arctic 2017 example
--------------------------------------------------------------------------------

Please see the example:

  % cd $HOME/DADA2_nifH_pipeline/Example

This is the same as /home/jmagasin/ToolsShared/NifH_amplicons/DADA2/Example.
There are docs that describe how to run the pipeline on a very small subset of
the Arctic 2017 data.  (You can probably begin at step 2:)


-- END --
